<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'Veronica & Bishoy â€” Wedding' %></title>

  <!-- CSRF Token -->
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

  <!-- Tailwind (dev only; switch to a build for prod) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    html {
      scroll-behavior: smooth;
      scroll-padding-top: 8rem; /* Offset for the sticky header (h-32) */
    }
    body { 
      height: 100%;
      font-family: 'EB Garamond', ui-serif, Georgia, Cambria, 'Times New Roman', Times, serif; 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale; 
    }
  </style>

  <%- block('head') %>
</head>
<body class="bg-white text-[#1E2A44] selection:bg-[#1E2A44] selection:text-white">

  <% if (typeof isAdmin === 'undefined' || !isAdmin) { %>
    <%- include('partials/main-header', { page: (typeof page !== 'undefined' ? page : 'internal'), viewer, csrfToken }) %>
  <% } %>

  <% const _fullWidth = (typeof fullWidth !== 'undefined' ? fullWidth : false); %>
  <main class="<%= _fullWidth ? '' : 'max-w-6xl mx-auto px-4' %>">
    <%- body %>
  </main>

  <% if (typeof isAdmin === 'undefined' || !isAdmin) { %>
    <footer id="contact-footer" class="bg-[#1E2A44] border-t border-stone-800 text-stone-300 pt-12 mt-16">
      <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-8">

        <!-- Left Column -->
        <div class="flex flex-col items-center text-center w-full md:w-1/3">
          <img src="/visual_assets/public/logo_gold_100x100.svg" alt="Veronica & Bishoy Logo" class="h-24 w-24 mb-4">
          <p class="text-xl font-semibold text-stone-100 mb-2">Veronica & Bishoy</p>
          <p class="text-sm mb-2">03.10.2025 | BERLIN</p>
          <a href="mailto:bishoy.veronica@gmail.com" class="text-sm hover:underline mb-1">bishoy.veronica@gmail.com</a>
          <div class="flex items-center gap-2 mt-1">
            <p class="text-sm">+49 15204085370</p>
            <a href="https://wa.me/4915204085370" target="_blank" rel="noopener noreferrer" class="hover:opacity-80 transition-opacity">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-green-500">
                <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.357 1.849 6.069l-1.254 4.587 4.762-1.249zM9.356 8.014c-.13-.304-.26-.304-.39-.304-.12 0-.26 0-.39 0s-.33.04-.52.24c-.19.2-.46.66-.46 1.62 0 .96.47 1.88.53 2.01.06.13.94 1.51 2.31 2.06.34.13.61.2.82.26.36.1.67.07.92-.06.29-.13.94-.43 1.08-.85.14-.42.14-.78.1-.85-.04-.07-.13-.12-.26-.24-.13-.12-.3-.2-.42-.26-.12-.06-.26-.04-.39.07-.13.12-.52.62-.63.74-.12.12-.22.13-.39.07-.16-.06-1.02-.38-1.95-1.21-.73-.64-1.22-1.44-1.35-1.69-.13-.24-.01-.38.07-.51.08-.12.18-.21.26-.3.08-.08.13-.13.18-.21.06-.08.01-.16-.04-.24-.05-.08-.39-.93-.53-1.29z"/>
              </svg>
            </a>
          </div>
        </div>

        <!-- Middle Column -->
        <div class="flex flex-col items-center md:items-start text-center md:text-left w-full md:w-1/3">
          <p class="font-semibold text-stone-100 mb-4">Quick Links</p>
          <ul class="space-y-2">
            <li><a href="/rsvp" class="hover:underline">RSVP</a></li>
            <li><a href="/#location" class="hover:underline">Locations</a></li>
            <li><a href="/#timeline" class="hover:underline">Timeline</a></li>
            <li><a href="/#faqs" class="hover:underline">FAQs</a></li>
          </ul>
        </div>

        <!-- Right Column -->
        <div class="flex flex-col items-center md:items-start text-center md:text-left w-full md:w-1/3">
          <p class="font-semibold text-stone-100 mb-4">Pages</p>
          <ul class="space-y-2">
            <li><a href="/story" class="hover:underline">Story</a></li>
            <li><a href="/gallery" class="hover:underline">Gallery</a></li>
          </ul>
        </div>

      </div>

      <!-- Copyright -->
      <div class="text-center mt-12 border-t border-stone-800 pt-8 pb-6">
        <p class="text-sm text-stone-400">&copy; 2024 Veronica & Bishoy. All Rights Reserved.</p>
      </div>
    </footer>
  <% } %>

  <%- include('partials/access-modal') %>

  <script>
    // --- Global access modal wiring (defensive edition) ---
    (function () {
      try {
        const accessBtn = document.getElementById('accessBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const modal     = document.getElementById('accessModal');
        const closeBtn  = document.getElementById('closeAccess');
        const form      = document.getElementById('accessForm');
        const input     = document.getElementById('accessCodeInput');
        const nextInp   = document.getElementById('accessNext');
        const errorEl   = document.getElementById('accessError');

        function open(nextPath) {
          if (!modal || !input || !nextInp || !errorEl) return; // Do nothing if elements are missing
          if (typeof nextPath === 'string') nextInp.value = nextPath;
          input.value = '';
          errorEl.classList.add('hidden');
          errorEl.textContent = '';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          setTimeout(() => input.focus(), 50);
        }
        window.showAccessModal = open;

        function close() {
          if (!modal) return;
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }

        accessBtn?.addEventListener('click', () => open('/'));
        logoutBtn?.addEventListener('click', () => {
          document.getElementById('logoutForm')?.submit();
        });

        form?.addEventListener('submit', async (event) => {
          event.preventDefault();
          const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          if (!token) {
            console.error('CSRF token not found!');
            if(errorEl) errorEl.textContent = 'Security token missing. Please refresh.';
            return;
          }

          const formData = new FormData(form);
          const payload = Object.fromEntries(formData);

          const response = await fetch('/access', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'CSRF-Token': token },
            body: JSON.stringify(payload)
          });

          const result = await response.json();

          if (result.error && errorEl) {
            errorEl.textContent = result.error;
            errorEl.classList.remove('hidden');
          } else if (result.success) {
            window.location.href = result.next || '/';
          }
        });

        closeBtn?.addEventListener('click', close);
        modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

        if (new URLSearchParams(window.location.search).has('showAccessModal')) {
          open('/');
        }
      } catch (e) {
        console.error('A critical error occurred in the global layout script. This might affect page functionality.', e);
      }
    })();
  </script>

  <%- block('scripts') %>
</body>
</html>
