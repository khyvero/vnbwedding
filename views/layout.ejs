<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'Veronica & Bishoy â€” Wedding' %></title>

  <!-- CSRF Token -->
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

  <!-- Tailwind (dev only; switch to a build for prod) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; scroll-behavior: smooth; }
    body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .serif { font-family: 'Playfair Display', ui-serif, Georgia, Cambria, 'Times New Roman', Times, serif; }
  </style>

  <%- block('head') %>
</head>
<body class="bg-white text-stone-900 selection:bg-stone-900 selection:text-white">

  <% if (typeof isAdmin === 'undefined' || !isAdmin) { %>
    <%- include('partials/main-header', { page: (typeof page !== 'undefined' ? page : 'internal'), viewer, csrfToken }) %>
  <% } %>

  <% const _fullWidth = (typeof fullWidth !== 'undefined') ? fullWidth : false; %>
  <main class="<%= _fullWidth ? '' : 'max-w-6xl mx-auto px-4' %>">
    <%- body %>
  </main>

  <% if (typeof isAdmin === 'undefined' || !isAdmin) { %>
    <footer id="contact-footer" class="bg-[#1E2A44] border-t border-stone-800 text-stone-300 py-12 mt-16">
      <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-8">

        <!-- Left Column -->
        <div class="flex flex-col items-center text-center w-full md:w-1/3">
          <img src="/visual_assets/public/logo_white_100x100.svg" alt="Veronica & Bishoy Logo" class="h-24 w-24 mb-4">
          <p class="serif text-xl font-semibold text-stone-100 mb-2">Veronica & Bishoy</p>
          <p class="text-sm mb-2">02.10.2025 | BERLIN</p>
          <a href="mailto:bishoy.veronica@gmail.com" class="text-sm hover:underline mb-1">bishoy.veronica@gmail.com</a>
          <p class="text-sm">+49 123 4567890</p>
        </div>

        <!-- Middle Column -->
        <div class="flex flex-col items-center md:items-start text-center md:text-left w-full md:w-1/3">
          <p class="font-semibold text-stone-100 mb-4">Quick Links</p>
          <ul class="space-y-2">
            <li><a href="/rsvp" class="hover:underline">RSVP</a></li>
            <li><a href="/#timeline" class="hover:underline">Timeline</a></li>
            <li><a href="/#faqs" class="hover:underline">FAQs</a></li>
          </ul>
        </div>

        <!-- Right Column -->
        <div class="flex flex-col items-center md:items-start text-center md:text-left w-full md:w-1/3">
          <p class="font-semibold text-stone-100 mb-4">//</p>
          <ul class="space-y-2">
            <li><a href="/story" class="hover:underline">Story</a></li>
          </ul>
        </div>

      </div>

      <!-- Copyright -->
      <div class="text-center mt-12 border-t border-stone-800 pt-8">
        <p class="text-sm text-stone-400">&copy; 2024 Veronica & Bishoy. All Rights Reserved.</p>
      </div>
    </footer>
  <% } %>

  <%- include('partials/access-modal') %>

  <script>
    // --- Global access modal wiring (defensive edition) ---
    (function () {
      try {
        const accessBtn = document.getElementById('accessBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const modal     = document.getElementById('accessModal');
        const closeBtn  = document.getElementById('closeAccess');
        const form      = document.getElementById('accessForm');
        const input     = document.getElementById('accessCodeInput');
        const nextInp   = document.getElementById('accessNext');
        const errorEl   = document.getElementById('accessError');

        function open(nextPath) {
          if (!modal || !input || !nextInp || !errorEl) return; // Do nothing if elements are missing
          if (typeof nextPath === 'string') nextInp.value = nextPath;
          input.value = '';
          errorEl.classList.add('hidden');
          errorEl.textContent = '';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          setTimeout(() => input.focus(), 50);
        }
        window.showAccessModal = open;

        function close() {
          if (!modal) return;
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }

        accessBtn?.addEventListener('click', () => open('/'));
        logoutBtn?.addEventListener('click', () => {
          document.getElementById('logoutForm')?.submit();
        });

        form?.addEventListener('submit', async (event) => {
          event.preventDefault();
          const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          if (!token) {
            console.error('CSRF token not found!');
            if(errorEl) errorEl.textContent = 'Security token missing. Please refresh.';
            return;
          }

          const formData = new FormData(form);
          const payload = Object.fromEntries(formData);

          const response = await fetch('/access', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'CSRF-Token': token },
            body: JSON.stringify(payload)
          });

          const result = await response.json();

          if (result.error && errorEl) {
            errorEl.textContent = result.error;
            errorEl.classList.remove('hidden');
          } else if (result.success) {
            window.location.href = result.next || '/';
          }
        });

        closeBtn?.addEventListener('click', close);
        modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

        if (new URLSearchParams(window.location.search).has('showAccessModal')) {
          open('/');
        }
      } catch (e) {
        console.error('A critical error occurred in the global layout script. This might affect page functionality.', e);
      }
    })();
  </script>

  <%- block('scripts') %>
</body>
</html>
