<% layout('layout', { fullWidth: true, pageTitle: 'RSVP - Veronica & Bishoy\'s Wedding' }) -%>

<section class="max-w-2xl mx-auto">
  <h2 class="serif text-3xl mb-6">RSVP</h2>

  <% if (viewer?.name) { %>
    <div class="flex items-center justify-between rounded-lg bg-blue-50 px-4 py-3 text-blue-800">
      <div>Hi, <strong><%= viewer.name %></strong> — you’re all set to RSVP.</div>
      <form id="logoutForm" method="post" action="/access/logout">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="button" id="logoutBtn" class="text-xs underline hover:no-underline">Not you?</button>
      </form>
    </div>
  <% } %>

  <form id="rsvpForm" method="post" action="/rsvp" class="space-y-6 bg-white p-4 rounded-xl shadow-sm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <!-- Ceremony -->
    <div class="mt-6">
      <label class="block font-medium mb-2">Will you join us for the Ceremony?</label>
      <label class="inline-flex items-center mr-6">
        <input type="radio" name="ceremony" value="yes" <%= defaults.ceremony==='yes'?'checked':'' %> />
        <span class="ml-2">Yes</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="ceremony" value="no"  <%= defaults.ceremony==='no'?'checked':'' %> />
        <span class="ml-2">No</span>
      </label>
    </div>

    <!-- Reception -->
    <div class="mt-6">
      <label class="block font-medium mb-2">Will you join us for the Reception?</label>
      <label class="inline-flex items-center mr-6">
        <input type="radio" name="reception" value="yes" <%= defaults.reception==='yes'?'checked':'' %> />
        <span class="ml-2">Yes</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="reception" value="no"  <%= defaults.reception==='no'?'checked':'' %> />
        <span class="ml-2">No</span>
      </label>
    </div>

    <!-- All subsequent questions are grouped here -->
    <div id="attendingExtras">
      <!-- Reception-only questions -->
      <div id="receptionExtras">
        <!-- What name would you like on your place card? -->
        <div class="mt-6">
          <label for="placeCardName" class="block font-medium mb-2">What name would you like on your place card?</label>
          <input id="placeCardName" name="placeCardName"
                 value="<%= defaults.placeCardName || '' %>"
                 class="w-full rounded-xl border px-3 py-2" />
        </div>

        <!-- Do you have any allergies or dietary requirements? -->
        <div class="mt-6">
          <label for="dietary" class="block font-medium mb-2">Do you have any allergies or dietary requirements?</label>
          <textarea id="dietary" name="dietary" rows="2"
                    class="w-full rounded-xl border px-3 py-2"><%= defaults.dietary || '' %></textarea>
          <p class="text-xs text-stone-500 mt-2 mb-8">
            We will share personalised dish options with you closer to the day.
          </p>
        </div>
      </div>

      <!-- Additional Guests -->
      <% if (maxGuests > 0) { %>
      <div class="space-y-4 border-t pt-6">
        <p class="font-medium">Additional Guests</p>
        <div id="guests" class="space-y-4">
          <% for(let i = 0; i < maxGuests; i++) { %>
            <div class="space-y-2 p-4 border rounded-lg">
              <p class="font-medium text-sm">Extra Guest <%= i + 1 %></p>
              <input name="guestNames[]" value="<%= (defaults.guests && defaults.guests[i]) ? defaults.guests[i].placeCardName : '' %>" placeholder="Guest name" class="w-full rounded-lg border border-stone-300 px-3 py-2">
              <input name="guestDietaries[]" value="<%= (defaults.guests && defaults.guests[i]) ? defaults.guests[i].dietary : '' %>" placeholder="Allergies/dietary" class="w-full rounded-lg border border-stone-300 px-3 py-2">
            </div>
          <% } %>
        </div>
      </div>
      <% } %>

      <!-- Transport -->
      <div id="transportSection" class="space-y-4 border-t pt-6 pb-8">
        <p class="font-medium">Do you require transport between the ceremony and reception venues?</p>
        <div class="flex items-center gap-6 mt-4">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="transport" value="yes" <%= defaults.transport==='yes'?'checked':'' %>>
            <span class="ml-2">Yes</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="transport" value="no"  <%= defaults.transport==='no'?'checked':'' %>>
            <span class="ml-2">No</span>
          </label>
        </div>
      </div>

      <!-- Printed Invitation -->
      <div class="border-t pt-6">
        <p class="font-medium">Would you like to receive a printed invitation card?</p>
        <div class="flex items-center gap-6 mt-4">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="printedInvite" value="yes" <%= defaults.printedInvite==='yes'?'checked':'' %>> Yes
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="printedInvite" value="no"  <%= defaults.printedInvite==='no'?'checked':'' %>> No
          </label>
        </div>
        <p class="text-xs text-stone-500 my-6">
            If yes, please send your full name and postal address via WhatsApp or Email.
            </p>
      </div>

      <!-- Notes -->
      <div class="space-y-4 border-t pt-6">
        <p class="font-medium">Special Assistance or Additional Notes:</p>
        <textarea name="notes" rows="3" class="w-full rounded-lg border border-stone-300 px-3 py-2"><%= defaults.notes || '' %></textarea>
      </div>

      <!-- Email -->
      <div class="space-y-4 pt-6">
        <p class="font-medium">Email (optional):</p>
        <input type="email" name="email" class="w-full rounded-lg border border-stone-300 px-3 py-2" value="<%= defaults.email || '' %>">
      </div>
    </div>

    <div class="flex items-center gap-4">
      <button type="submit" class="rounded-xl px-5 py-3 bg-stone-900 text-white hover:bg-stone-800">Submit</button>
      <a href="/" class="rounded-xl px-5 py-3 bg-stone-200 text-stone-800 hover:bg-stone-300">Cancel</a>
    </div>
  </form>
</section>

<script>
  (function(){
    const extras = document.getElementById('receptionExtras');
    const nameInp = document.getElementById('placeCardName');
    const transportSection = document.getElementById('transportSection');
    const attendingExtras = document.getElementById('attendingExtras');

    function sync(){
      const ceremonySel = document.querySelector('input[name="ceremony"]:checked');
      const receptionSel = document.querySelector('input[name="reception"]:checked');

      const isAttendingCeremony = ceremonySel && ceremonySel.value === 'yes';
      const isAttendingReception = receptionSel && receptionSel.value === 'yes';
      const isAttendingAnything = isAttendingCeremony || isAttendingReception;

      // Show/hide the entire block of follow-up questions
      if (attendingExtras) attendingExtras.classList.toggle('hidden', !isAttendingAnything);

      // Show/hide reception-specific questions (name, dietary)
      if (extras) extras.classList.toggle('hidden', !isAttendingReception);
      if (nameInp) nameInp.required = isAttendingReception;

      // Show/hide transport question (only if attending BOTH ceremony and reception)
      const showTransport = isAttendingCeremony && isAttendingReception;
      if (transportSection) transportSection.classList.toggle('hidden', !showTransport);
    }

    document.querySelectorAll('input[name="ceremony"], input[name="reception"]').forEach(function(r){
      r.addEventListener('change', sync);
    });
    sync(); // initial state on load

    // --- CSRF token refresh ---
    const rsvpForm = document.getElementById('rsvpForm');
    const rsvpSubmitBtn = rsvpForm?.querySelector('button[type="submit"]');
    const logoutForm = document.getElementById('logoutForm');
    const logoutBtn = document.getElementById('logoutBtn');

    function refreshToken(form) {
        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const input = form.querySelector('input[name="_csrf"]');
        if (token && input) {
            input.value = token;
        }
    }

    // When clicking the submit button, just refresh the token.
    // The form will submit on its own as a default browser action.
    rsvpSubmitBtn?.addEventListener('click', () => {
        refreshToken(rsvpForm);
    });

    // When clicking the "Not you?" button, refresh the token and then submit the logout form
    logoutBtn?.addEventListener('click', () => {
        refreshToken(logoutForm);
        logoutForm?.submit();
    });

  })();
</script>
